<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${resultado.id != null} ? 'Editar Resultado - UTS' : 'Nuevo Resultado - UTS'"></title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo-container">
            <div class="logo-icon">UTS</div>
            <div class="logo-text">UTS Saber Pro</div>
        </div>
        
        <nav class="nav-menu">
            <a th:href="@{/coordinacion/dashboard}" class="nav-link">Dashboard</a>
            <a th:href="@{/coordinacion/estudiantes}" class="nav-link">Estudiantes</a>
            <a th:href="@{/coordinacion/resultados}" class="nav-link">Resultados</a>
            <a th:href="@{/coordinacion/informes/beneficios}" class="nav-link">Informes</a>
        </nav>
        
        <div class="user-info">
            <span th:text="${session.nombre}"></span>
            <a th:href="@{/logout}" class="btn btn-secondary btn-sm">Cerrar Sesi√≥n</a>
        </div>
    </header>

    <main class="dashboard-container">
        <div class="dashboard-header">
            <h1 class="dashboard-title" th:text="${resultado.id != null} ? 'Editar Resultado' : 'Nuevo Resultado'"></h1>
            <p class="dashboard-subtitle" th:text="${resultado.id != null} ? 
                'Actualice los resultados de la prueba' : 
                'Registre nuevos resultados de pruebas Saber Pro o T&T'"></p>
        </div>

        <!-- Result Form -->
        <div style="background: white; border-radius: 12px; padding: 40px; box-shadow: 0 5px 20px var(--color-sombra);">
            <form th:action="@{/coordinacion/resultados/guardar}" th:object="${resultado}" method="post">
                <!-- Hidden ID for editing -->
                <input type="hidden" th:field="*{id}">
                
                <!-- Basic Information Section -->
                <div style="margin-bottom: 40px;">
                    <h3 style="color: var(--color-verde-texto); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid var(--color-gris-claro);">
                        üìã Informaci√≥n B√°sica
                    </h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                        <div class="form-group">
                            <label for="estudiante" class="form-label required">Estudiante *</label>
                            <select th:field="*{estudiante.id}" id="estudiante" class="form-input" required>
                                <option value="">Seleccione un estudiante</option>
                                <option th:each="est : ${estudiantes}" 
                                        th:value="${est.id}" 
                                        th:text="${est.primerNombre + ' ' + est.primerApellido + ' - ' + est.numeroDocumento}">
                                </option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="tipoPrueba" class="form-label required">Tipo de Prueba *</label>
                            <select th:field="*{tipoPrueba}" id="tipoPrueba" class="form-input" required onchange="updateScoreLimits()">
                                <option value="">Seleccione tipo</option>
                                <option value="SABER_PRO">Saber Pro (0-300 puntos)</option>
                                <option value="SABER_TT">Saber T&T (0-200 puntos)</option>
                            </select>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                        <div class="form-group">
                            <label for="fechaExamen" class="form-label required">Fecha del Examen *</label>
                            <input type="date" th:field="*{fechaExamen}" id="fechaExamen" class="form-input" required>
                        </div>

                        <div class="form-group">
                            <label for="puntajeGlobal" class="form-label required">Puntaje Global *</label>
                            <input type="number" th:field="*{puntajeGlobal}" id="puntajeGlobal" 
                                   class="form-input" min="0" max="300" step="1" 
                                   placeholder="Puntaje global" required onchange="calculateLevels()">
                            <small class="help-text" id="scoreLimitText">M√°ximo: 300 puntos</small>
                            <div id="scoreFeedback" style="margin-top: 5px; font-size: 12px;"></div>
                        </div>
                    </div>
                </div>

                <!-- Competencias Gen√©ricas -->
                <div style="margin-bottom: 40px;">
                    <h3 style="color: var(--color-verde-texto); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid var(--color-gris-claro);">
                        üéØ Competencias Gen√©ricas
                    </h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                        <!-- Columna 1 -->
                        <div>
                            <div class="form-group">
                                <label for="comunicacionEscrita" class="form-label">Comunicaci√≥n Escrita</label>
                                <input type="number" th:field="*{comunicacionEscrita}" id="comunicacionEscrita" 
                                       class="form-input competencia-input" min="0" max="300" step="1" 
                                       placeholder="Puntaje" onchange="calculateCompetenceLevel('comunicacionEscrita')">
                                <small class="help-text" id="comunicacionEscritaLevel"></small>
                            </div>

                            <div class="form-group">
                                <label for="razonamientoCuantitativo" class="form-label">Razonamiento Cuantitativo</label>
                                <input type="number" th:field="*{razonamientoCuantitativo}" id="razonamientoCuantitativo" 
                                       class="form-input competencia-input" min="0" max="300" step="1" 
                                       placeholder="Puntaje" onchange="calculateCompetenceLevel('razonamientoCuantitativo')">
                                <small class="help-text" id="razonamientoCuantitativoLevel"></small>
                            </div>

                            <div class="form-group">
                                <label for="lecturaCritica" class="form-label">Lectura Cr√≠tica</label>
                                <input type="number" th:field="*{lecturaCritica}" id="lecturaCritica" 
                                       class="form-input competencia-input" min="0" max="300" step="1" 
                                       placeholder="Puntaje" onchange="calculateCompetenceLevel('lecturaCritica')">
                                <small class="help-text" id="lecturaCriticaLevel"></small>
                            </div>
                        </div>

                        <!-- Columna 2 -->
                        <div>
                            <div class="form-group">
                                <label for="competenciasCiudadanas" class="form-label">Competencias Ciudadanas</label>
                                <input type="number" th:field="*{competenciasCiudadanas}" id="competenciasCiudadanas" 
                                       class="form-input competencia-input" min="0" max="300" step="1" 
                                       placeholder="Puntaje" onchange="calculateCompetenceLevel('competenciasCiudadanas')">
                                <small class="help-text" id="competenciasCiudadanasLevel"></small>
                            </div>

                            <div class="form-group">
                                <label for="ingles" class="form-label">Ingl√©s</label>
                                <input type="number" th:field="*{ingles}" id="ingles" 
                                       class="form-input competencia-input" min="0" max="300" step="1" 
                                       placeholder="Puntaje" onchange="calculateCompetenceLevel('ingles')">
                                <small class="help-text" id="inglesLevel"></small>
                            </div>

                            <div class="form-group">
                                <label for="nivelInglesMarco" class="form-label">Nivel Marco Ingl√©s</label>
                                <select th:field="*{nivelInglesMarco}" id="nivelInglesMarco" class="form-input">
                                    <option value="">Seleccione nivel</option>
                                    <option value="A0">A0 - Principiante</option>
                                    <option value="A1">A1 - Acceso</option>
                                    <option value="A2">A2 - Plataforma</option>
                                    <option value="B1">B1 - Intermedio</option>
                                    <option value="B2">B2 - Intermedio Alto</option>
                                    <option value="C1">C1 - Dominio Operativo Eficaz</option>
                                    <option value="C2">C2 - Maestr√≠a</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Competencias Espec√≠ficas (Solo para Saber Pro) -->
                <div id="competenciasEspecificas" style="margin-bottom: 40px; display: none;">
                    <h3 style="color: var(--color-verde-texto); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid var(--color-gris-claro);">
                        üîß Competencias Espec√≠ficas (Saber Pro)
                    </h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                        <div class="form-group">
                            <label for="formulacionProyectos" class="form-label">Formulaci√≥n de Proyectos</label>
                            <input type="number" th:field="*{formulacionProyectos}" id="formulacionProyectos" 
                                   class="form-input competencia-input" min="0" max="300" step="1" 
                                   placeholder="Puntaje" onchange="calculateCompetenceLevel('formulacionProyectos')">
                            <small class="help-text" id="formulacionProyectosLevel"></small>
                        </div>

                        <div class="form-group">
                            <label for="pensamientoCientifico" class="form-label">Pensamiento Cient√≠fico</label>
                            <input type="number" th:field="*{pensamientoCientifico}" id="pensamientoCientifico" 
                                   class="form-input competencia-input" min="0" max="300" step="1" 
                                   placeholder="Puntaje" onchange="calculateCompetenceLevel('pensamientoCientifico')">
                            <small class="help-text" id="pensamientoCientificoLevel"></small>
                        </div>

                        <div class="form-group">
                            <label for="disenoSoftware" class="form-label">Dise√±o de Software</label>
                            <input type="number" th:field="*{disenoSoftware}" id="disenoSoftware" 
                                   class="form-input competencia-input" min="0" max="300" step="1" 
                                   placeholder="Puntaje" onchange="calculateCompetenceLevel('disenoSoftware')">
                            <small class="help-text" id="disenoSoftwareLevel"></small>
                        </div>
                    </div>
                </div>

                <!-- Preview Section -->
                <div id="previewSection" style="background: var(--color-fondo-input); padding: 20px; border-radius: 8px; margin-bottom: 30px; display: none;">
                    <h4 style="color: var(--color-verde-texto); margin-bottom: 15px;">üëÅÔ∏è Vista Previa</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 14px;">
                        <div>
                            <strong>Puntaje Global:</strong> 
                            <span id="previewGlobalScore">-</span> 
                            <span id="previewGlobalLevel" class="badge" style="margin-left: 10px;">-</span>
                        </div>
                        <div>
                            <strong>Beneficios:</strong> 
                            <span id="previewBenefits">-</span>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div style="display: flex; gap: 15px; justify-content: flex-end; padding-top: 20px; border-top: 1px solid var(--color-gris-claro);">
                    <a th:href="@{/coordinacion/resultados}" class="btn btn-secondary">
                        ‚ùå Cancelar
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <span th:if="${resultado.id != null}">üíæ Actualizar Resultado</span>
                        <span th:if="${resultado.id == null}">‚ûï Registrar Resultado</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Help Information -->
        <div style="background: white; border-radius: 12px; padding: 20px; margin-top: 20px; box-shadow: 0 5px 20px var(--color-sombra);">
            <h4 style="color: var(--color-verde-texto); margin-bottom: 15px;">üí° Escalas de Puntaje</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h5 style="color: var(--color-verde-medio); margin-bottom: 10px;">Saber Pro (0-300)</h5>
                    <ul style="color: var(--color-gris-texto); font-size: 14px; line-height: 1.6;">
                        <li><strong>Nivel 1:</strong> 0 - 125 puntos</li>
                        <li><strong>Nivel 2:</strong> 126 - 155 puntos</li>
                        <li><strong>Nivel 3:</strong> 156 - 190 puntos</li>
                        <li><strong>Nivel 4:</strong> 191 - 300 puntos</li>
                    </ul>
                </div>
                <div>
                    <h5 style="color: var(--color-verde-medio); margin-bottom: 10px;">Saber T&T (0-200)</h5>
                    <ul style="color: var(--color-gris-texto); font-size: 14px; line-height: 1.6;">
                        <li><strong>Nivel 1:</strong> 0 - 125 puntos</li>
                        <li><strong>Nivel 2:</strong> 126 - 155 puntos</li>
                        <li><strong>Nivel 3:</strong> 156 - 190 puntos</li>
                        <li><strong>Nivel 4:</strong> 191 - 200 puntos</li>
                    </ul>
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScript for Dynamic Form Behavior -->
    <script>
        function updateScoreLimits() {
            const tipoPrueba = document.getElementById('tipoPrueba').value;
            const puntajeGlobal = document.getElementById('puntajeGlobal');
            const scoreLimitText = document.getElementById('scoreLimitText');
            const competenciasEspecificas = document.getElementById('competenciasEspecificas');
            
            if (tipoPrueba === 'SABER_TT') {
                puntajeGlobal.max = 200;
                scoreLimitText.textContent = 'M√°ximo: 200 puntos';
                competenciasEspecificas.style.display = 'none';
            } else {
                puntajeGlobal.max = 300;
                scoreLimitText.textContent = 'M√°ximo: 300 puntos';
                if (tipoPrueba === 'SABER_PRO') {
                    competenciasEspecificas.style.display = 'block';
                }
            }
            
            calculateLevels();
        }
        
        function calculateLevels() {
            const tipoPrueba = document.getElementById('tipoPrueba').value;
            const puntajeGlobal = document.getElementById('puntajeGlobal').value;
            const scoreFeedback = document.getElementById('scoreFeedback');
            const previewSection = document.getElementById('previewSection');
            const previewGlobalScore = document.getElementById('previewGlobalScore');
            const previewGlobalLevel = document.getElementById('previewGlobalLevel');
            const previewBenefits = document.getElementById('previewBenefits');
            
            if (puntajeGlobal) {
                previewSection.style.display = 'block';
                previewGlobalScore.textContent = puntajeGlobal + ' puntos';
                
                // Calculate level
                let level = calculateNivel(parseInt(puntajeGlobal), tipoPrueba);
                previewGlobalLevel.textContent = level;
                previewGlobalLevel.className = 'badge ' + getLevelBadgeClass(level);
                
                // Calculate benefits
                const benefits = calculateBenefits(parseInt(puntajeGlobal), tipoPrueba);
                previewBenefits.textContent = benefits;
                
                // Update feedback
                if (tipoPrueba === 'SABER_TT' && puntajeGlobal < 80) {
                    scoreFeedback.innerHTML = '<span style="color: #dc3545;">‚ùå No aprobado (m√≠nimo 80 puntos)</span>';
                } else if (tipoPrueba === 'SABER_PRO' && puntajeGlobal < 120) {
                    scoreFeedback.innerHTML = '<span style="color: #dc3545;">‚ùå No aprobado (m√≠nimo 120 puntos)</span>';
                } else {
                    scoreFeedback.innerHTML = '<span style="color: #28a745;">‚úÖ Aprobado</span>';
                }
            } else {
                previewSection.style.display = 'none';
                scoreFeedback.innerHTML = '';
            }
        }
        
        function calculateCompetenceLevel(competenceId) {
            const input = document.getElementById(competenceId);
            const levelElement = document.getElementById(competenceId + 'Level');
            
            if (input.value) {
                const score = parseInt(input.value);
                const level = calculateNivel(score, 'COMPETENCIA');
                levelElement.textContent = 'Nivel: ' + level;
                levelElement.style.color = getLevelColor(level);
            } else {
                levelElement.textContent = '';
            }
        }
        
        function calculateNivel(puntaje, tipo) {
            if (tipo === 'SABER_TT') {
                if (puntaje >= 191) return 'Nivel 4';
                else if (puntaje >= 156) return 'Nivel 3';
                else if (puntaje >= 126) return 'Nivel 2';
                else return 'Nivel 1';
            } else {
                if (puntaje >= 191) return 'Nivel 4';
                else if (puntaje >= 156) return 'Nivel 3';
                else if (puntaje >= 126) return 'Nivel 2';
                else return 'Nivel 1';
            }
        }
        
        function getLevelBadgeClass(level) {
            switch(level) {
                case 'Nivel 4': return 'badge-success';
                case 'Nivel 3': return 'badge-warning';
                case 'Nivel 2': return '';
                case 'Nivel 1': return 'badge-danger';
                default: return '';
            }
        }
        
        function getLevelColor(level) {
            switch(level) {
                case 'Nivel 4': return '#28a745';
                case 'Nivel 3': return '#ffc107';
                case 'Nivel 2': return '#6c757d';
                case 'Nivel 1': return '#dc3545';
                default: return '#6c757d';
            }
        }
        
        function calculateBenefits(puntaje, tipo) {
            if (tipo === 'SABER_TT') {
                if (puntaje < 80) return 'No graduable';
                if (puntaje >= 120 && puntaje <= 150) return 'Exoneraci√≥n TG + Nota 4.5';
                if (puntaje >= 151 && puntaje <= 170) return 'Exoneraci√≥n TG + Nota 4.7 + 50% beca';
                if (puntaje > 171) return 'Exoneraci√≥n TG + Nota 5.0 + 100% beca';
                return 'Aprobado sin beneficios';
            } else {
                if (puntaje < 120) return 'No graduable';
                if (puntaje >= 180 && puntaje <= 210) return 'Exoneraci√≥n TG + Nota 4.5';
                if (puntaje >= 211 && puntaje <= 240) return 'Exoneraci√≥n TG + Nota 4.7 + 50% beca';
                if (puntaje > 241) return 'Exoneraci√≥n TG + Nota 5.0 + 100% beca';
                return 'Aprobado sin beneficios';
            }
        }
        
        // Initialize form
        document.addEventListener('DOMContentLoaded', function() {
            updateScoreLimits();
            calculateLevels();
            
            // Calculate levels for existing values
            const competencias = ['comunicacionEscrita', 'razonamientoCuantitativo', 'lecturaCritica', 
                                 'competenciasCiudadanas', 'ingles', 'formulacionProyectos', 
                                 'pensamientoCientifico', 'disenoSoftware'];
            competencias.forEach(comp => calculateCompetenceLevel(comp));
        });
    </script>
</body>
</html>